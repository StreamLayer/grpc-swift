---
format_version: '6'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: ios

workflows:
  deploy:
    steps:
    - script:
        deps:
          brew:
          - name: node
          - name: nsoperations/formulas/carthage
          - name: streamlayer/formulas/prefixify
        inputs:
        - content: |-
            #!/bin/bash
            set -ex
            rm -rf Carthage ~/Library/Caches/org.carthage.CarthageKit/build
            yarn
            # 5.3+df4651b6117805e4aa1fc1bc0670304e is xcode 12.1 vesion
            if [ "$(carthage swift-version)" !=  "5.3+df4651b6117805e4aa1fc1bc0670304e" ]; then
              echo "Invalid swift version" 1>&2
              exit 1
            fi
            carthage bootstrap

            # https://github.com/Carthage/Carthage/issues/3019#issuecomment-665136323

            xcconfig=$(mktemp /tmp/static.xcconfig.XXXXXX)
            trap 'rm -f "$xcconfig"' INT TERM HUP EXIT

            # For Xcode 12 make sure EXCLUDED_ARCHS is set to arm architectures otherwise
            # the build will fail on lipo due to duplicate architectures.
            echo 'EXCLUDED_ARCHS__EFFECTIVE_PLATFORM_SUFFIX_simulator__NATIVE_ARCH_64_BIT_x86_64__XCODE_1200 = arm64 arm64e armv7 armv7s armv6 armv8' >> $xcconfig
            echo 'EXCLUDED_ARCHS = $(inherited) $(EXCLUDED_ARCHS__EFFECTIVE_PLATFORM_SUFFIX_$(EFFECTIVE_PLATFORM_SUFFIX)__NATIVE_ARCH_64_BIT_$(NATIVE_ARCH_64_BIT)__XCODE_$(XCODE_VERSION_MAJOR))' >> $xcconfig
            XCODE_XCCONFIG_FILE="$xcconfig" yarn semantic-release
